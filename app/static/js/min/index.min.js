function init_default_content(){content={title:words_default[0],text:[]};for(var t=1;t<words_default.length;t++)content.text.push(words_default[t])}function set_direction(){var t="rtl"===content.direction,e=t?"rtl":"ltr";$("html").toggleClass("rtl",t),$("#spritz").attr("dir",e),$("#spritz_words").attr("dir",e),$("#spritz_forward").attr("title",t?rwtitles[1]:rwtitles[0]),$("#spritz_back").attr("title",t?rwtitles[0]:rwtitles[1])}function set_content_html(){set_direction(),$("#spritz_words").empty(),$("#spritz_words").append("<header>"+content.title+"</header>"),content.text.forEach(function(t){$("#spritz_words").append("<p>"+t+"</p>")})}function words_load(){localStorage.jqspritz?(local_spritz=JSON.parse(localStorage.jqspritz),local_spritz.night&&(night=!0,$("html").addClass("night")),local_spritz.autosave&&(autosave=!0,$("html").addClass("autosave"),$("#autosave_checkbox").prop("checked",!0)),$wpm.val(local_spritz.wpm),interval=6e4/local_spritz.wpm,spritz_zoom(0),content=local_spritz.content,word_index=local_spritz.word,words_set(),word_show(),word_update(),spritz_pause(!0),spritz_alert("loaded")):(init_default_content(),word_index=0,words_set(),word_show(),word_update(),spritz_pause(!0))}function words_save(){local_spritz={word:word_index,content:content,wpm:$wpm.val(),night:night,autosave:autosave,zoom:zoom},localStorage.jqspritz=JSON.stringify(local_spritz),autosave?button_flash("save",500):spritz_alert("saved")}function words_set(){set_content_html(),words=content.text.join(" ").trim().replace(/([\u2010-\u2014])(\S)/g,"$1 $2").replace(/(\S)\-(\S)/g,"$1- $2").replace(rePunctnTrl,"$1 ⁋ ").split(/\s+/)}function word_show(){word_index>=words.length&&(word_index=words.length-1),0>word_index&&(word_index=0),$("#spritz_progress").width(100*word_index/words.length+"%");var t=words[word_index];if("⁋"!=t){var e=0,r=t.match(rePunctnBeg);r&&(e+=r[0].length);var o=t.length,a=t.match(rePunctnEnd);a&&(o-=a[0].length);var i=o-e;if(!(0>=i)){var s=Math.round(.4*(i+1))-1,n="rtl"===content.direction&&t.slice(e,o).match(reInverseRtl);n?(s=o-s-1,$space.html('<div dir="ltr">'+t.slice(s+1)+'</div><div dir="ltr">'+t[s]+'</div><div dir="ltr">'+t.slice(0,s)+"</div>")):(s+=e,$space.html("<div>"+t.slice(0,s)+"</div><div>"+t[s]+"</div><div>"+t.slice(s+1)+"</div>"))}}}function word_next(){word_index++,word_show()}function word_prev(){word_index--,word_show()}function word_update(){spritz=setInterval(function(){word_next(),word_index+1==words.length&&(setTimeout(function(){$space.html(""),spritz_pause(!0),word_index=0,word_show()},interval),clearInterval(spritz))},interval)}function spritz_pause(t){paused||(clearInterval(spritz),paused=!0,$("html").addClass("paused"),autosave&&!t&&words_save())}function spritz_play(){word_update(),paused=!1,$("html").removeClass("paused")}function spritz_flip(){paused?spritz_play():spritz_pause()}function spritz_speed(){interval=6e4/$("#spritz_wpm").val(),paused||(clearInterval(spritz),word_update()),$("#spritz_save").removeClass("saved loaded")}function spritz_faster(){$("#spritz_wpm").val(parseInt($("#spritz_wpm").val())+50),spritz_speed()}function spritz_slower(){$("#spritz_wpm").val()>=100&&$("#spritz_wpm").val(parseInt($("#spritz_wpm").val())-50),spritz_speed()}function spritz_back(){spritz_pause(),word_index>=1&&word_prev()}function spritz_forward(){spritz_pause(),word_index<words.length&&word_next()}function spritz_back_bidi(){"rtl"===content.direction?spritz_forward():spritz_back()}function spritz_forward_bidi(){"rtl"===content.direction?spritz_back():spritz_forward()}function spritz_zoom(t){zoom+=t,$("#spritz").css("font-size",zoom+"em")}function spritz_refresh(){clearInterval(spritz),words_set(),spritz_pause(),word_index=0,word_show()}function spritz_home(){window.location=location.origin+location.pathname}function spritz_autosave(){$("html").toggleClass("autosave"),autosave=!autosave,autosave?$("#autosave_checkbox").prop("checked",!0):$("#autosave_checkbox").prop("checked",!1)}function spritz_status(t){return $("#img-loading").hide(),$("#alert").attr("title","").text(t)}function spritz_alert(t){var e="";switch(t){case"loaded":e="Data loaded from local storage";break;case"saved":e="Settings have been saved in local storage for the next time you visit";break;case"erased":e="Your saved settings have been erased"}return spritz_status(e).fadeIn().delay(2e3).fadeOut()}function spritz_error(t){return spritz_status(t).fadeIn().delay(5e3).fadeOut()}function button_flash(t,e){var r=$(".controls a."+t);r.addClass("active"),"undefined"==typeof e&&(e=100),setTimeout(function(){r.removeClass("active")},e)}function get_url_param(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),r=e.exec(location.search);return null==r?"":decodeURIComponent(r[1].replace(/\+/g," "))}function preproc_text(t,e,r){r=$.trim(r).replace(/\s+/g," ");var o=t+e+r;return o.replace(/\./g,". ").replace(/\?/g,"? ").replace(/\!/g,"! ")}function spritzify_url(t){var e="http";if(t.length>e.length){var r=t.substring(0,e.length).toLowerCase();r!=e&&(t=e+"://"+t)}article_url=document.getElementById("article-url"),article_url.href=t;var o=20,a="/"===article_url.pathname?"":article_url.pathname,i=article_url.hostname+a,s=i.substring(0,o);$("#alert").text("Loading "+s+" ...").attr("title","Loading "+i).add("#img-loading").fadeIn(),spritzify_url_with(t,["SpritsIt"])}function spritzify_url_with(t,e){try{if(0==e.length)throw"No parsers remaining!";var r=e.shift(),o=get_parser(r),a=o.uri+"?token="+o.get_token()+"&url="+encodeURIComponent(t)+"&callback=?";r='Parser "'+o.name+'"',console.log(r+": requesting "+a),jQuery.getJSON(a,function(o){if(o.error)return spritz_error("Article extraction failed."),void 0;if(0==o.word_count)return console.log(r+": word count is zero, trying alternative API..."),spritzify_url_with(t,e);console.log(r+": language = "+o.lang),console.log(r+": word count = "+o.word_count);var a="";""!==o.title&&(a=o.title,null!==o.author&&"en"===o.lang&&(a=a+", by "+o.author));var i=jQuery.trim(o.content),s=o.direction||"ltr";content={title:a,direction:s,text:i.split(/\n/)},spritz_status(""),words_set(),word_index=0,word_show(),spritz_pause(!0)}).done(function(){console.log(r+": done.")}).fail(function(t,e,o){var a=e+", "+o;console.log(r+": fail: "+a),spritz_error("Article extraction failed.")}).always(function(){console.log(r+": always.")})}catch(i){console.log("Error in spritzify_url: "+i),spritz_error("Article extraction failed.")}}function create_bookmarklet(){var t=location.origin+location.pathname,e="javascript:"+encodeURIComponent('function iptxt(){var d=document;try{if(!d.body)throw(0);window.location="'+t+'?url="+encodeURIComponent(d.location.href);}catch(e){alert("Please wait until the page has loaded.");}}iptxt();void(0)');$("#bookmarklet").attr("href",e),$("#bookmarklet").click(function(){return!1}),$("#bookmarklet-code").val(e),$("#bookmarklet-code").click(function(){this.focus(),this.select()})}var $wpm=$("#spritz_wpm"),interval=6e4/$wpm.val(),paused=!1,$space=$("#spritz_word"),night=!1,zoom=1,autosave=!1,local_spritz={},content={},words=[],word_index=0,rePunctnGen=/[\"\'\,\.\!\?\:\;\*\~\+\-_¡¿‘’“”«»„\[\]\(\)\{\}…©®™]+/g,rePunctnBeg=new RegExp("^"+rePunctnGen.source),rePunctnEnd=new RegExp(rePunctnGen.source+"$"),rePunctnTrl=/([\"\'\.\!\?\:\;\*\~\+\-_¡¿‘’“”«»„\[\]\(\)\{\}…©®™]+)\s/g,reInverseRtl=/^[\d\w\u0660-\u066c]+$/;$("#spritz_wpm").on("input",function(){spritz_speed()}),$(".controls").on("click","a, label",function(){switch(this.id){case"spritz_slower":spritz_slower();break;case"spritz_faster":spritz_faster();break;case"spritz_save":words_save();break;case"spritz_pause":spritz_flip();break;case"spritz_smaller":spritz_zoom(-.1);break;case"spritz_bigger":spritz_zoom(.1);break;case"spritz_autosave":spritz_autosave();break;case"spritz_refresh":spritz_refresh();break;case"spritz_home":spritz_home();break;case"spritz_back":spritz_back_bidi();break;case"spritz_forward":spritz_forward_bidi()}return!1}),$(".controls").on("mousedown","a",function(){switch(this.id){case"spritz_back":spritz_jog_back=setInterval(function(){spritz_back_bidi()},100);break;case"spritz_forward":spritz_jog_forward=setInterval(function(){spritz_forward_bidi()},100)}}),$(".controls").on("mouseup","a",function(){switch(this.id){case"spritz_back":clearInterval(spritz_jog_back);break;case"spritz_forward":clearInterval(spritz_jog_forward)}}),$(document).on("keyup",function(t){switch(t.keyCode){case 32:spritz_flip(),button_flash("pause");break;case 37:spritz_back(),button_flash("back");break;case 38:spritz_faster(),button_flash("faster");break;case 39:spritz_forward(),button_flash("forward");break;case 40:spritz_slower(),button_flash("slower")}}),$(document).on("keydown",function(t){switch(t.keyCode){case 37:spritz_back(),button_flash("back");break;case 39:spritz_forward(),button_flash("forward")}}),$(".light").on("click",function(){return $("html").toggleClass("night"),night=!night,!1}),$("a.toggle").on("click",function(){return $(this).siblings(".togglable").slideToggle(),!1}),$(".erase-storage").on("click",function(){return delete localStorage.jqspritz,spritz_alert("erased"),!1}),$(document).ready(function(){create_bookmarklet(),custom_url=get_url_param("url"),custom_url.match(/www\.gutenberg\.org/gi)&&(alert(gutenberg_alert.join("\n\n")),custom_url=""),custom_url?spritzify_url(custom_url):words_load()}),window.addEventListener("pageshow",function(){spritz_pause(!0)},!1),window.addEventListener("pagehide",function(){spritz_pause(!0)},!1);